{% extends "base.html" %}

{% block title %}Quiz {{ step }}: {{ q.title }} — Vine Voyage{% endblock %}

{% block extra_head %}
  <style>
    /* 1) Drag-and-drop grid (UNCHANGED) */
    #draggables {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .draggable-item {
      background: var(--color-light-grey);
      border-radius: 8px;
      height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: grab;
      padding: 0.5rem;
      text-align: center;
      user-select: none;
    }

    /* 2) Drop-zone (UNCHANGED) */
    #drop-zone {
      background: var(--color-light-grey);
      border: 2px dashed var(--color-dark-grey);
      border-radius: 8px;
      padding: 1rem;
      min-height: 200px;
      transition: background 0.2s;
    }
    #drop-zone.bg-light {
      background: #e8e8e8;
    }

    /* 3) Image-pick grid: force each cell to exactly 120×120px */
    .image-pick-grid {
      display: grid;
      gap: 1rem;
      margin-bottom: 1rem;
      justify-content: center;
      /* these two will now always win over any inline style: */
      grid-template-columns: repeat(4, 120px) !important;
      grid-auto-rows: 120px     !important;
    }
    .image-pick-grid button {
      width: 120px;
      height: 120px;
      padding: 0;
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .image-pick-grid img.glass-img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      object-position: center center;
      display: block;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="quiz-step-container" style="padding:2rem; max-width:800px; margin:0 auto;">
    {% set customer_idx = ((step - 1) // 3) + 1 %}

    <h2 class="mb-3">Customer {{ customer_idx }}: {{ q.title }}</h2>
    <p class="prompt mb-4">{{ q.prompt }}</p>

    {% if not show_feedback %}
      <form method="post">
        <input type="hidden" name="dropped_items" id="dropped-items-input" value="">

        {% if q['type'] == 'dragAndDrop' %}
          <!-- your drag/drop markup is exactly the same -->
          <div id="draggables" class="mb-4">
            {% for item in q['draggables'] %}
              <div class="draggable-item"
                   draggable="true"
                   data-label="{{ item.label }}"
                   id="item-{{ loop.index0 }}">
                <img src="{{ url_for('static', filename='images/' ~ item.image) }}"
                     alt="{{ item.label }}"
                     style="width:60px; height:60px; object-fit:contain; margin-bottom:0.5rem;">
                <div class="font-weight-bold">{{ item.label }}</div>
              </div>
            {% endfor %}
          </div>
          <div id="drop-zone" class="mb-2 text-center"><p>Drag items here</p></div>
          <div id="selected-count" class="text-muted mb-4">
            Selected: 0 of {{ q['draggables']|selectattr('correct')|list|length }}
          </div>
          <button type="submit" class="btn btn-hero">Submit</button>

        {% elif q['type'] == 'imagePick' %}
          <!-- **here** we removed the inline style completely -->
          <div class="image-pick-grid mb-4">
            {% for idx, img in enumerate(q['images']) %}
              <button type="submit" name="choice" value="{{ idx }}">
                <img
                  class="glass-img"
                  src="{{ url_for('static', filename='images/glasses/' ~ img.src) }}"
                  alt="Glass {{ idx+1 }}">
              </button>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-hero">Submit</button>

        {% else %}
          {% for idx, choice in enumerate(q['choices']) %}
            <div class="form-check mb-3">
              <input class="form-check-input"
                     type="radio"
                     name="choice"
                     id="c{{ idx }}"
                     value="{{ idx }}"
                     {% if loop.first %}checked{% endif %}>
              <label class="form-check-label" for="c{{ idx }}">{{ choice }}</label>
            </div>
          {% endfor %}
          <button type="submit" class="btn btn-hero">Submit</button>
        {% endif %}
      </form>
    {% endif %}

    {% if show_feedback %}
      <a href="{{ url_for('quiz_step', step=step+1) }}" class="btn btn-hero mt-4">Continue</a>
      {% if q.get('answer') is not none %}
        <p class="feedback font-weight-bold mt-3">
          Correct Answer: {{ q['choices'][ q['answer'] ] }}
          {% if q.get('explanation') %} ({{ q['explanation'] }}){% endif %}
        </p>
      {% else %}
        <p class="feedback font-weight-bold mt-3">Correct!</p>
      {% endif %}
    {% elif error %}
      <p class="text-danger font-weight-bold mt-3">{{ error }}</p>
    {% endif %}
  </div>
{% endblock %}

{% block extra_scripts %}
  {% if q['type'] == 'dragAndDrop' %}
    <script>
      const draggables  = document.querySelectorAll(".draggable-item");
      const dropZone    = document.getElementById("drop-zone");
      const counter     = document.getElementById("selected-count");
      const hiddenInput = document.getElementById("dropped-items-input");
      let selected = [];

      draggables.forEach(item => {
        item.addEventListener("dragstart", e => {
          e.dataTransfer.setData("text/plain", item.dataset.label);
        });
      });

      dropZone.addEventListener("dragover", e => {
        e.preventDefault();
        dropZone.classList.add("bg-light");
      });
      dropZone.addEventListener("dragleave", e => {
        dropZone.classList.remove("bg-light");
      });
      dropZone.addEventListener("drop", e => {
        e.preventDefault();
        dropZone.classList.remove("bg-light");
        const label = e.dataTransfer.getData("text/plain");
        if (!label || selected.includes(label)) return;
        selected.push(label);
        hiddenInput.value = selected.join(",");

        const badge = document.createElement("span");
        badge.textContent = label;
        badge.className   = "badge badge-secondary m-1";
        dropZone.appendChild(badge);

        const totalCorrect = {{ q['draggables']|selectattr('correct')|list|length }};
        counter.textContent = `Selected: ${selected.length} of ${totalCorrect}`;
      });
    </script>
  {% endif %}
{% endblock %}
